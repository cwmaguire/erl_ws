<!--
%% Copyright (c) 2015, Chris Maguire <cwmaguire@gmail.com>
%%
%% Permission to use, copy, modify, and/or distribute this software for any
%% purpose with or without fee is hereby granted, provided that the above
%% copyright notice and this permission notice appear in all copies.
%%
%% THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
%% WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
%% MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
%% ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
%% WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
%% ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
%% OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

%% Draw in an HTML5 canvas with commands from a Websocket
%%
%% Connects to an Erlang Cowboy Websocket to trigger animation from
%% Erlang.
-->
<html>
<script language="JavaScript">
  var exampleSocket;
  var results;
  var canvas;

  function init(){
    log("init");
    results = document.getElementById("results");
    canvas = document.getElementById("canvas");
    exampleSocket = new WebSocket("ws://localhost:8080/animate");
    exampleSocket.onopen = handle_ws_event;
    exampleSocket.onmessage = handle_ws_message;
  }

  function handle_ws_event(event) {
    if(event.type = "open"){
      handle_ws_open();
    }
  }

  function handle_ws_open(){
    log("Websocket is OPEN!");
  };

  function handle_ws_message(event) {
    //log("Data from Websocket: " + event.data);
    if(event.data.substring(0,1) == "["){
      draw(event.data);
    }else{
      log("" + event.data.substring(0,1) + " does not equal '['");
    }
  };

  function start(){
    exampleSocket.send("height:" + canvas.clientHeight);
    exampleSocket.send("width:" + canvas.clientWidth);
    exampleSocket.send("start");
  }

  function stop(){
    exampleSocket.send("stop");
  }

  function log(str){
    console.dir(str);
  }

  function draw(json) {
    objs = JSON.parse(json);
    var canvas = document.getElementById("canvas");
    if (canvas.getContext) {
      ctx = canvas.getContext("2d");
      blankCanvas(ctx, canvas);
      objs.forEach(function(obj){
        //log("drawing obj");
        switch(obj.shape){
          case "rectangle": drawRect(ctx, obj);
                            break;
          case "ellipse":   drawEllipse(ctx, obj);
                            break;
          default:
                            log("Not drawing anything of shape " + obj.shape);
        };
      });
    }
  }

  function blankCanvas(ctx, canvas){
      drawRect(ctx,
               {x: 0, y: 0,
                h: canvas.height, w: canvas.width,
                r: 255, g: 255, b: 255, a: 1.0});
  }

  function drawRect(ctx, obj){
      var fillStyle = "rgba(" + obj.r + "," + obj.g + "," + obj.b + ", " + obj.a + ")";
      ctx.fillStyle = fillStyle;
      ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
  }

  function drawEllipse(ctx, obj){
      var fillStyle = "rgba(" + obj.r + "," + obj.g + "," + obj.b + ", " + obj.a + ")";
      ctx.fillStyle = fillStyle;
      ctx.beginPath();
      ctx.arc(obj.x, obj.y, obj.rad, obj.start, obj.end);
      ctx.lineTo(obj.x, obj.y);
      ctx.closePath();
      ctx.fill();
  }

</script>
<body onload="init();">
  <button onclick="start();">Start</button>
  <button onclick="stop();">Stop</button>
  <br>
  <canvas id=canvas height=300 width=500 style="border: 1px solid black;"></canvas>
  <div id=results></div>
</body>
</html>
